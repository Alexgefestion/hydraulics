<!DOCTYPE html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>
<script src="script/classes/CommonLiquid.js"></script>
<script src="script/classes/CommonBlock.js"></script>
<script src="script/classes/Nasos1.js"></script>
<style>
* {
	box-sizing: border-box;
	padding: 0px;
	margin: 0px;
}
body {
	background-color: #3c4e60;
}
.main {
	display: flex;
	height: 100vh;
}
	.view {
		flex-basis: 80%;
		background-color: #f1948a;

		display: flex;
		flex-direction: column;
	}
		.viewPort {
			flex-grow: 1;
			background-color: #c39bd3;
		}
			.viewPort > svg {
				height: 100%;
				width: 100%;
			}
		.viewInfo {
			flex-basis: 30px;
			background-color: #2c3e50;
			color: #dadada;
			display: flex;
		}
			.scaleInfo {
				flex-basis: 15%;
			}
			.xInfo {
				flex-basis: 10%;
			}
			.yInfo {
				flex-basis: 10%;
			}
			.currTargetInfo {
				flex-basis: 25%;
			}
			.toolInfo {
				flex-basis: 45%;
			}
	.menu {
		flex-basis: 20%;
		background-color: #2c3e50 ;
		height: 100vh;
		display: flex;
	}
		.tools {
			flex-basis: 10%;


			display: flex;
			flex-direction: column;
		}
			.tool {
				margin-top: 1vh;
				flex-basis: 5vh;
				transition-duration: 0.5s;
			}
			.tool:hover {
				cursor:pointer;
				background-color: #1c2e40;
			}
			.tool > svg {
				width: 100%;
				height: 100%;
				fill: none;
			    stroke: #dadada;
			    stroke-miterlimit: 10;
			    stroke-width: 4px;
			}
		.toolOption {
			margin-left: 1vh;
			overflow: hidden;
			color: #dadada;
			flex-basis: 90%;
		}
			.blockOption {
				display: flex;
				flex-wrap: wrap;
			}
				.blockOption > input{
					background-color: #1c2e40;
					color: #dadada;
					background-clip: padding-box;
					border: 1px solid #bdbdbd;
					border-radius: 0.25rem;
					line-height: 1.5;
				}
			.addBlock {
				transition-duration: 0.2s;
				display: none;
				flex-wrap: wrap;
			}
			.addBlock > div {
				flex-basis: 33.33%;

			}

			.liquidOption {
				display: none;
				flex-wrap: wrap;
			}
	.node:hover {
		cursor: pointer;
		fill: #fff;
	}
</style>
<body>
	<div class="main">
		<div class="view">
			<div class="viewPort">
				<svg id="workSpace"
					x="0px" y="0px"
					xmlns="http://www.w3.org/2000/svg" 
					viewBox="0 0 1000 1000"
					xml:space="preserve">
					<rect id="view" x="0" y="0" width="1920" height="1080" fill="#5c6e80" stroke-width="1" stroke="black"/>
				</svg>
			</div>
			<div class="viewInfo">
				<div class="scaleInfo">
					<output id="scaleOut" value="1">100%</output>
				</div>
				<div class="xInfo">
					<output id="xOut" value="0">0</output>
				</div>
				<div class="yInfo">
					<output id="yOut" value="0">0</output>
				</div>
				<div class="currTargetInfo">
					<output id="currTargetOut">Рабочее поле</output>
				</div>
				<div  class="toolInfo">
					<output id="toolOut">Свойства блока</output>
				</div>
			</div>
		</div>
		<div  class="menu">
			<div class="tools">
				<div class="tool">
					<svg onClick="setMode(0)" width="10" height="10" viewBox="0 0 100 100">
						<polygon points="20 93 20 4 85 69 48 68 20 93"/>
					</svg>
				</div>
				<div class="tool">
					<svg onClick="setMode(1)" width="10" height="10" viewBox="0 0 100 100">
						<line x1="50" y1="90" x2="50" y2="10"/>
						<line x1="10" y1="50" x2="90" y2="50"/>
					</svg>
				</div>
				<div class="tool">
					<svg onClick="setMode(2)" width="10" height="10" viewBox="0 0 100 100">
						<path fill="#3f6fff" d="M75.5,65.2l-9.5,17.2s-3.2,9.5,9.5,9.5c12.7,0,9.5-9.5,9.5-9.5l-9.5-17.2Z"/>
						<path fill="#3f6fff" d="M19.9,43.3c-1.4,1.4-2.3,3.4-2.3,5.7s.9,4.2,2.3,5.7l20,20.2c1.4,1.4,3.4,2.3,5.7,2.3,2.2,0,4.2-.9,5.7-2.3l31.3-31.3s-6-6-18.6,0-16.3,2.7-22.9,0-21.1-.2-21.1-.2Z"/>
						<path fill="none" d="M51.1,12.1l-31.2,31.2c-1.4,1.4-2.3,3.4-2.3,5.7s.9,4.2,2.3,5.7l20,20.2c1.4,1.4,3.4,2.3,5.7,2.3,2.2,0,4.2-.9,5.7-2.3l31.3-31.3L47.2,8.2c-1.4-1.4-3.4-2.3-5.7-2.3s-4.2.9-5.7,2.3l-5.9,5.9"/>
					</svg>
				</div>
				<div class="tool">
					<svg onClick="setMode(4)" width="10" height="10" viewBox="0 0 100 100">
						<rect x="20" y="11.5" width="20" height="15"/>
						<rect x="60" y="73.5" width="20" height="15"/>
						<path d="M20,33v14c0,7.2,5.8,13,13,13h14"/>
						<path d="M40,33v5c0,1.1.9,2,2,2h5"/>
						<path d="M40,27c1.7,0,3,1.3,3,3s-1.3,3-3,3h-20c-1.7,0-3-1.3-3-3s1.3-3,3-3h20"/>
						<path d="M80,67c1.7,0,3,1.3,3,3s-1.3,3-3,3h-20c-1.7,0-3-1.3-3-3s1.3-3,3-3h20"/>
						<path d="M47,40c0-1.7,1.3-3,3-3s3,1.3,3,3v20c0,1.7-1.3,3-3,3s-3-1.3-3-3v-20"/>
						<path d="M80.5,66.5v-14c0-7.2-5.8-13-13-13h-14"/>
						<path d="M60.5,66.5v-5c0-1.1-.9-2-2-2h-5"/>
					</svg>
				</div>
			</div>
			<div id="toolOption" class="toolOption">
				<div id="blockOption" class="blockOption">
				</div>
				<div id="addBlock" class="addBlock">
				</div>
				<div id="liquidOption" class="liquidOption">
					<p>Название</p>
					<input type="text">
					<p>Вязкоть</p>
					<input type="number">
					<p>Плотность</p>
					<input type="number">
					<p>Цвет</p>
					<input type="color" oninput="changeLiquidOption(this.value)">
				</div>
			</div>
		</div>
	</div>
</body>
</html>
<script>

	function getBlockOption(option){
		blockOption.innerHTML = "";
		for (let i = 0; i < option.length; i++) {
			blockOption.innerHTML += `
			<div>	
				<p>${option[i][0]}</p>
				<input type="${option[i][2]}" value="${option[i][1]}">
			</div>`
		}
	}



	let viewPortWidth = 1920;
	let viewPortHeight = 1080;
	let currScale = 1;
	let currViewX = 0;
	let currViewY = 0;

	let grid = 10;

	let currLiquid = 0;	
	let currTarget = 0;

	let flagMode = 0
//перемнные режимов
	//0
	//1
	//2
	//3-устновка соединений
	let prevPipeCord = [-1,-1];
	let prevNode = [-1,0];

	pipes=[
	{
	Xcord: 50,
	Ycord: 98,
	connect: [[-1,0],[-1,1]]
	}
	]



	let Liquid = [new CommonLiquid()];
	let Block = [];


	//       @@@@@@@@    @@@     @@    @@@@@@@@    @@@@@@@@ 
	//          @@       @@@@    @@       @@          @@
	//          @@       @@ @@   @@       @@          @@
	//          @@       @@  @@  @@       @@          @@
	//          @@       @@   @@ @@       @@          @@
	//          @@       @@    @@@@       @@          @@
	//       @@@@@@@@    @@     @@@    @@@@@@@@       @@


	function init(){
		for (key in blockClasses) {
			addBlock.innerHTML += `
			<div>
				${key}
				${blockClasses[key].getMiniIcon()}
			</div>`
		}
		viewPortWidth = document.querySelector(".viewPort").clientWidth;
		viewPortHeight = document.querySelector("body").clientHeight-30;
		workSpace.setAttribute("viewBox", `${currViewX} ${currViewY } ${viewPortWidth/currScale} ${viewPortHeight/currScale}`);
	}


	//         @@@@@    @@@@@@      @@@@@@@@       @@       @@@@@@@@    @@@@@@@@
	//        @@        @@   @@     @@            @@@@         @@       @@
	//       @@         @@    @@    @@           @@  @@        @@       @@
	//       @@         @@   @@     @@@@@@       @@  @@        @@       @@@@@@
	//       @@         @@@@@       @@          @@@@@@@@       @@       @@
	//        @@        @@  @@      @@          @@    @@       @@       @@
	//         @@@@@    @@   @@     @@@@@@@@    @@    @@       @@       @@@@@@@@
	let blockClasses = {
		"Nasos1": Nasos1,
		"Nasos2": Nasos1
	}
	function createBlock(className){
		let index = Block.length;
		Block[index] = new blockClasses[className]({
			id: index,
			Xcord: getXcoords(currViewX+(viewPortWidth/2)),
			Ycord: getYcoords(currViewY+(viewPortHeight/2)),
			liquid: Liquid[currLiquid]
		});
		workSpace.innerHTML += Block[index].getIcon();
		Block[index].drawNodes();
	}




	function pipe(node){
		if(flagMode!=3){
			prevNode = node;
			prevPipeCord = [Block[node[0]].Xcord+Block[node[0]].nodes[node[1]]['cx'], Block[node[0]].Ycord+Block[node[0]].nodes[node[1]]['cy']];
			setMode(3);
		}else{
			createPipePath([Block[node[0]].Xcord+Block[node[0]].nodes[node[1]]['cx'], Block[node[0]].Ycord+Block[node[0]].nodes[node[1]]['cy']]);
			setMode(1);
			Block[prevNode[0]].nodes[node[1]]['connected'] = node;
			Block[node[0]].nodes[node[1]]['connected'] = prevNode;
		}
		
		// let currPipe = pipes.length;
		// endNode = startNode;
		// startNode = node;
		// endCords = startCords;
		// startCords = [cords[0]+Block[startNode[0]].Xcord,cords[1]+Block[startNode[0]].Ycord];
		// if(endNode[0] != -1){
		// 	pipes[currPipe]=
		// 		{	
		// 			startNode: startNode,
		// 			endNode: endNode,
		// 			startCords: startCords,
		// 			endCords: endCords,
		// 			connect: [startNode,endNode]
		// 		}
		// 	console.log(pipes[currPipe]["startCords"])
		// 	drawPipe(pipes[currPipe],Block[startNode[0]].liquid.fill);
		// 	startNode[0] = -1;
		// }	
	}
  	function drawPipe(pipeData, fill){
  		workSpace.innerHTML += `
  			<line
  			id="node${s}"
  			x1="${pipeData["startCords"][0]}" 
  			y1="${pipeData["startCords"][1]}" 
  			x2="${pipeData["endCords"][0]}" 
  			y2="${pipeData["endCords"][1]}" 
  			stroke="${fill}"
  			stroke-width="5px"
  			/>
  		`
  	}
  	function createPipePath(newPipeCord){
  		workSpace.innerHTML += `
  			<line
  			id="node"
  			x1="${prevPipeCord[0]}"
  			y1="${prevPipeCord[1]}"
  			x2="${newPipeCord[0]}"
  			y2="${newPipeCord[1]}"
  			stroke="${Block[prevNode[0]].liquid.fill}"
  			stroke-width="5px"
  			/>
  		`
  		prevPipeCord = newPipeCord;
  	}
	//       @@@@@@@@    @@    @@    @@@@@@@@    @@@     @@    @@@@@@@@
	//       @@          @@    @@    @@          @@@@    @@       @@
	//       @@          @@    @@    @@          @@ @@   @@       @@
	//       @@@@@@       @@  @@     @@@@@@      @@  @@  @@       @@
	//		 @@           @@  @@     @@          @@   @@ @@       @@
	//       @@            @@@@      @@          @@    @@@@       @@
	//		 @@@@@@@@       @@       @@@@@@@@    @@     @@@       @@


	//key
	//mouse
	let leftMouseKey = 0;
	document.addEventListener("mousedown", function(e) {
		let targetId = e.target.getAttribute("id");
		if(targetId != null){
			//обработка по id
			if(targetId == 'view'){
				setCurrTarget(-1);
				if(flagMode != 3){
					setMode(1);
				}
			}else if(targetId.startsWith("block")) {
				setCurrTarget(targetId.split("block")[1]);
				setMode(0);
				getBlockOption(Block[currTarget].getOption());

			}else if(targetId.startsWith("node")) {
				currTargetOut.innerHTML = Block[targetId.split("node")[1].split("_")[0]].name + ' узел: ' + targetId.split("node")[1].split("_")[1];

			}
			//обработка по нажатой клавише
			if(e.button == 0){
				leftMouseKey = 1;
			} 
			//обработка по режиму
			if(flagMode == 3){
				// createPipePath([getXcoords(e.clientX), getYcoords(e.clientY)]);
			}
		}
	});
	document.addEventListener("mouseup", function(e) {
		if(e.button == 0){
			leftMouseKey = 0;
		}

	});


	toolOption.addEventListener("mousewheel", function(e) {
		let element = document.querySelector(".addBlock");
		let curr = element.offsetTop-e.deltaY;
		if(curr < 1){
			element.style.marginTop = `${curr}px`;
		}

	});

	workSpace.addEventListener("mousewheel", function(e) {
	    if (e.ctrlKey) {
	       e.preventDefault();
	       viewPortX(e.deltaY);
	       return false;
	    }
	    if (e.altKey) {
	       e.preventDefault();
	       viewPortScale(-e.deltaY/1000);
	       return false;
	    }
	    viewPortY(e.deltaY);
	});
	workSpace.addEventListener('mousemove', function(e){
		if(flagMode == 0){
			if(leftMouseKey == 1){

				let newX = (e.clientX/currScale)+currViewX;
				let newY = (e.clientY/currScale)+currViewY;
				newX=Math.round(newX/grid)*grid;
				newY=Math.round(newY/grid)*grid;
				Block[currTarget].move(newX, newY);
			}
		}
	});
	workSpace.addEventListener("click", function(e){

	});
	function changeLiquidOption(color){
		Liquid[currLiquid].fill = color;
		Block.forEach((item) => {
			item.reDraw();
		});
	}
	function setMode(mode){
		if (mode == 0){
			workSpace.style.cursor = "url('./style/cur/pointer.png'), pointer";
			flagMode = mode;
			blockOption.style.display = "flex";
			addBlock.style.display = "none";
			liquidOption.style.display = "none";
			toolOut.innerHTML = "Свойства блока";
			return;
		}
		if (mode == 1){
			workSpace.style.cursor = "url('./style/cur/create.png'), pointer";
			flagMode = mode;
			blockOption.style.display = "none";
			addBlock.style.display = "flex";
			liquidOption.style.display = "none";
			toolOut.innerHTML = "Создание блока";
			return;
		}
		if (mode == 2){
			workSpace.style.cursor = "url('./style/cur/liquid.png'), pointer";
			flagMode = mode;
			blockOption.style.display = "none";
			addBlock.style.display = "none";
			liquidOption.style.display = "flex";
			toolOut.innerHTML = "Свойства жидкости";
			return;
		}
		if(mode == 3){
			flagMode = mode;
			toolOut.innerHTML = "установка труб";
		}
	}
	function setCurrTarget(newid){
		currTarget = newid;
		if (newid != -1){
			currTargetOut.innerHTML = Block[newid].name;
		}else{
			currTargetOut.innerHTML = "Рабочее поле";
		}	

	}
	function viewPortScale(scaleArg) {
		if(currScale<=0.1){
			currScale+= scaleArg/10;
			currScale=Number((currScale).toFixed(2));
		}else{
			currScale+= scaleArg;
			currScale=Number((currScale).toFixed(1));
		}
		if(currScale <= 0.01){
			currScale  = 0.01;
		}

		workSpace.setAttribute("viewBox", `${currViewX} ${currViewY } ${viewPortWidth/currScale} ${viewPortHeight/currScale}`);
		scaleOut.value = currScale*100+'%';
	}

	function viewPortX(xArg) {
		currViewX+= xArg/currScale;
		currViewX=Math.round(currViewX);
		workSpace.setAttribute("viewBox", `${currViewX} ${currViewY } ${viewPortWidth/currScale} ${viewPortHeight/currScale}`);
		xOut.value = currViewX;
	}

	function viewPortY(yArg) {
		currViewY+= yArg/currScale;
		currViewY=Math.round(currViewY);
		workSpace.setAttribute("viewBox", `${currViewX} ${currViewY } ${viewPortWidth/currScale} ${viewPortHeight/currScale}`);
		yOut.value = currViewY;
	}

	function getXcoords(mouseCoords){
		let newX = (mouseCoords/currScale)+currViewX;
		newX=Math.round(newX/grid)*grid;
		return newX;
	}
	function getYcoords(mouseCoords){
		let newY = (mouseCoords/currScale)+currViewY;
		newY=Math.round(newY/grid)*grid;
		return newY;
	}
	init();
</script>